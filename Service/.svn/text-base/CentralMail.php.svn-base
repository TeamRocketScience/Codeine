<?php

/*
 * Демон отправки сообщений
 */

$Messages = new Collection('Message');
$Messages->Query('=Sended=False');

$Messages->Slice(0,10);
$Messages->Load();

Transport::Mount('Jabber', 'Jabber', 'admin:admin@bth-laptop:5222');
Transport::Mount('Mail', 'Mail');

foreach ($Messages as $M)
        {
            $Receiver = new Object($M->Get('RType'),$M->Get('RName'));
            $Sender = new Object($M->Get('SType'),$M->Get('SName'));
            Transport::Send($M->Get('Method'), $M->Get('Subject'), $M->Get('Message'), $Receiver, $Sender, false);
            $M->Set('Sended',time());
            $M->Save();
        }